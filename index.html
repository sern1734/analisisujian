import React, { useState, useEffect, useMemo } from 'react';
import { BarChart, Bar, PieChart, Pie, Cell, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';

// Constant for subjects to be analyzed
const MATA_PELAJARAN = [
    'BC', 'BM', 'BI', 'MT', 'SN', 'PM/PAI', 'SEJ', 'PSV', 'MZ', 'PJ', 'PK', 'RBT'
];

// Grade definition based on score
const dapatkanGred = (markah) => {
    const skor = parseInt(markah, 10);
    if (isNaN(skor) || skor < 0) return { gred: 'F', nilai: 6 };
    if (skor >= 82) return { gred: 'A', nilai: 1 };
    if (skor >= 66) return { gred: 'B', nilai: 2 };
    if (skor >= 50) return { gred: 'C', nilai: 3 };
    if (skor >= 35) return { gred: 'D', nilai: 4 };
    if (skor >= 20) return { gred: 'E', nilai: 5 };
    return { gred: 'F', nilai: 6 };
};

// Colors for the grade distribution pie chart
const WARNA_GRED = { A: '#0284c7', B: '#059669', C: '#f59e0b', D: '#ef4444', E: '#8b5cf6', F: '#71717a' };

const App = () => {
    // State management
    const [dataAnalisis, setDataAnalisis] = useState(null);
    const [dataMentah, setDataMentah] = useState(null);
    const [senaraiTarikh, setSenaraiTarikh] = useState([]);
    const [tarikhDipilih, setTarikhDipilih] = useState('');
    const [kelasDipilih, setKelasDipilih] = useState('');
    const [subjekDipilih, setSubjekDipilih] = useState('Semua');
    const [memuatkan, setMemuatkan] = useState(true);
    const [ralat, setRalat] = useState(null);

    // Effect for fetching and processing data
    useEffect(() => {
        const fetchData = async () => {
            setMemuatkan(true);
            try {
                const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vS6N1ia0ISmQ3AtJq7mJNV7sHZLEfmaruSjP6ZCw8J7xF_JlvSbVa1HeK5dNiq5FaPWZrcWwARQyzLj/pub?output=csv');
                if (!response.ok) throw new Error(`Ralat HTTP! Status: ${response.status}`);
                const csvText = await response.text();

                const baris = csvText.trim().split('\n');
                const header = baris[0].split(',').map(h => h.trim());
                const dataMurid = baris.slice(1).map(row => {
                    const nilai = row.split(',');
                    return header.reduce((obj, nextKey, index) => {
                        obj[nextKey] = nilai[index] ? nilai[index].trim() : '';
                        return obj;
                    }, {});
                });

                // Group data by date and then by class
                const dataPerTarikhDanKelas = dataMurid.reduce((acc, murid) => {
                    const tarikh = murid['Tarikh 日期'];
                    const namaKelas = murid['Kelas 班级'];
                    if (!tarikh || !namaKelas) return acc;
                    if (!acc[tarikh]) acc[tarikh] = {};
                    if (!acc[tarikh][namaKelas]) {
                        acc[tarikh][namaKelas] = {
                            murid: [],
                            namaGuru: murid['Nama Guru Kelas 级任老师姓名']
                        };
                    }
                    acc[tarikh][namaKelas].murid.push(murid);
                    return acc;
                }, {});
                setDataMentah(dataPerTarikhDanKelas);
                
                // Perform analysis for each class on each date
                const analisisPenuh = {};
                for (const tarikh in dataPerTarikhDanKelas) {
                    analisisPenuh[tarikh] = {};
                    for (const namaKelas in dataPerTarikhDanKelas[tarikh]) {
                        const kelas = dataPerTarikhDanKelas[tarikh][namaKelas];
                        const bilanganMurid = kelas.murid.length;
                        const analisisSubjek = {};

                        MATA_PELAJARAN.forEach(subjek => {
                            const kiraanGred = { A: 0, B: 0, C: 0, D: 0, E: 0, F: 0 };
                            let jumlahSkorGred = 0;

                            kelas.murid.forEach(murid => {
                                const { gred, nilai } = dapatkanGred(murid[subjek]);
                                kiraanGred[gred]++;
                                jumlahSkorGred += nilai;
                            });

                            analisisSubjek[subjek] = {
                                kiraanGred,
                                gpmp: bilanganMurid > 0 ? (jumlahSkorGred / bilanganMurid) : 0
                            };
                        });
                        analisisPenuh[tarikh][namaKelas] = { analisisSubjek, bilanganMurid, namaGuru: kelas.namaGuru };
                    }
                }
                
                setDataAnalisis(analisisPenuh);
                const senaraiTarikhUnik = Object.keys(analisisPenuh).sort();
                setSenaraiTarikh(senaraiTarikhUnik);
                if (senaraiTarikhUnik.length > 0) {
                    setTarikhDipilih(senaraiTarikhUnik[0]);
                }

            } catch (error) {
                console.error("Gagal memuatkan atau memproses data:", error);
                setRalat("Tidak dapat memuatkan data peperiksaan. Sila pastikan pautan CSV adalah betul dan boleh diakses.");
            } finally {
                setMemuatkan(false);
            }
        };
        fetchData();
    }, []);

    // Effect to update class list when date changes
    useEffect(() => {
        if (tarikhDipilih && dataAnalisis) {
            const senaraiKelasSediaAda = Object.keys(dataAnalisis[tarikhDipilih] || {});
            setKelasDipilih(senaraiKelasSediaAda[0] || '');
            setSubjekDipilih('Semua'); // Reset subject filter
        }
    }, [tarikhDipilih, dataAnalisis]);

    // Memoized values for charts and tables
    const senaraiKelas = useMemo(() => {
        return tarikhDipilih && dataAnalisis ? Object.keys(dataAnalisis[tarikhDipilih] || {}).sort() : [];
    }, [tarikhDipilih, dataAnalisis]);

    const dataPaparan = useMemo(() => {
        if (tarikhDipilih && kelasDipilih && dataAnalisis) {
            return dataAnalisis[tarikhDipilih]?.[kelasDipilih];
        }
        return null;
    }, [tarikhDipilih, kelasDipilih, dataAnalisis]);
    
    const dataMuridDipilih = useMemo(() => {
         if (tarikhDipilih && kelasDipilih && dataMentah) {
            return dataMentah[tarikhDipilih]?.[kelasDipilih]?.murid || [];
        }
        return [];
    }, [tarikhDipilih, kelasDipilih, dataMentah]);

    if (memuatkan) {
        return <div className="flex items-center justify-center h-screen bg-gray-900 text-white">Memuatkan data dashboard...</div>;
    }
    if (ralat) {
        return <div className="flex items-center justify-center h-screen bg-gray-900 text-red-400 p-8">{ralat}</div>;
    }

    // Main render
    return (
        <div className="bg-gray-900 text-gray-200 min-h-screen p-4 sm:p-6 lg:p-8 font-sans">
            <div className="max-w-7xl mx-auto">
                <header className="mb-8">
                    <h1 className="text-3xl md:text-4xl font-bold text-white mb-2">Dashboard Analisis Peperiksaan</h1>
                    <p className="text-lg text-gray-400">Analisis Gred Purata Mata Pelajaran (GPMP) mengikut Tarikh, Kelas dan Subjek.</p>
                </header>

                {/* Filters Section */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    {/* Date Filter */}
                    <div>
                        <label htmlFor="tarikh-select" className="block text-sm font-medium text-gray-300 mb-2">Pilih Tarikh:</label>
                        <select id="tarikh-select" value={tarikhDipilih} onChange={(e) => setTarikhDipilih(e.target.value)} className="w-full bg-gray-800 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 transition">
                            {senaraiTarikh.map(tarikh => <option key={tarikh} value={tarikh}>{tarikh}</option>)}
                        </select>
                    </div>
                    {/* Class Filter */}
                    <div>
                        <label htmlFor="kelas-select" className="block text-sm font-medium text-gray-300 mb-2">Pilih Kelas:</label>
                        <select id="kelas-select" value={kelasDipilih} onChange={(e) => setKelasDipilih(e.target.value)} className="w-full bg-gray-800 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 transition" disabled={!tarikhDipilih}>
                            {senaraiKelas.map(namaKelas => <option key={namaKelas} value={namaKelas}>{namaKelas}</option>)}
                        </select>
                    </div>
                    {/* Subject Filter */}
                    <div>
                        <label htmlFor="subjek-select" className="block text-sm font-medium text-gray-300 mb-2">Pilih Mata Pelajaran:</label>
                        <select id="subjek-select" value={subjekDipilih} onChange={(e) => setSubjekDipilih(e.target.value)} className="w-full bg-gray-800 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 transition" disabled={!kelasDipilih}>
                            <option value="Semua">Semua Mata Pelajaran</option>
                            {MATA_PELAJARAN.map(subjek => <option key={subjek} value={subjek}>{subjek}</option>)}
                        </select>
                    </div>
                </div>

                {dataPaparan && (
                    <>
                        {/* --- VIEW FOR ALL SUBJECTS --- */}
                        {subjekDipilih === 'Semua' && (
                            <>
                                <div className="bg-gray-800 rounded-xl p-6 mb-8 shadow-lg">
                                    <h2 className="text-2xl font-semibold text-white mb-4">Ringkasan Kelas: {kelasDipilih} ({tarikhDipilih})</h2>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-center">
                                        <div className="bg-gray-700 p-4 rounded-lg"><p className="text-sm text-gray-400">Nama Guru Kelas</p><p className="text-xl font-bold text-cyan-400">{dataPaparan.namaGuru}</p></div>
                                        <div className="bg-gray-700 p-4 rounded-lg"><p className="text-sm text-gray-400">Bilangan Murid</p><p className="text-xl font-bold text-cyan-400">{dataPaparan.bilanganMurid}</p></div>
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                    <div className="bg-gray-800 rounded-xl p-6 shadow-lg">
                                        <h3 className="text-xl font-semibold text-white mb-4">Analisis GPMP & Gred</h3>
                                        <div className="overflow-x-auto"><table className="w-full text-sm text-left text-gray-300">
                                            <thead className="text-xs text-gray-400 uppercase bg-gray-700"><tr><th className="px-4 py-3">Mata Pelajaran</th>{Object.keys(WARNA_GRED).map(g => <th key={g} className="px-4 py-3 text-center">{g}</th>)}<th className="px-4 py-3 text-right">GPMP</th></tr></thead>
                                            <tbody>{MATA_PELAJARAN.map(subjek => { const dataSubjek = dataPaparan.analisisSubjek[subjek]; return (<tr key={subjek} className="border-b border-gray-700 hover:bg-gray-600/50"><td className="px-4 py-3 font-medium text-white">{subjek}</td>{Object.values(dataSubjek.kiraanGred).map((kiraan, i) => <td key={i} className="px-4 py-3 text-center">{kiraan}</td>)}<td className="px-4 py-3 text-right font-bold text-amber-400">{dataSubjek.gpmp.toFixed(2)}</td></tr>); })}</tbody>
                                        </table></div>
                                    </div>
                                    <div className="bg-gray-800 rounded-xl p-6 shadow-lg">
                                        <h3 className="text-xl font-semibold text-white mb-4">Carta GPMP Mengikut Mata Pelajaran</h3><p className="text-sm text-gray-400 mb-4">(GPMP lebih rendah adalah lebih baik)</p>
                                        <ResponsiveContainer width="100%" height={400}>
                                            <BarChart data={MATA_PELAJARAN.map(subjek => ({ name: subjek, GPMP: parseFloat(dataPaparan.analisisSubjek[subjek].gpmp.toFixed(2)) }))} layout="vertical" margin={{ top: 5, right: 20, left: 20, bottom: 5 }}>
                                                <CartesianGrid strokeDasharray="3 3" stroke="#4A5568" /><XAxis type="number" domain={[0, 6]} stroke="#9CA3AF" /><YAxis dataKey="name" type="category" stroke="#9CA3AF" width={60} />
                                                <Tooltip contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #4B5563' }} labelStyle={{ color: '#F9FAFB' }} />
                                                <Bar dataKey="GPMP" fill="#2DD4BF" />
                                            </BarChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>
                            </>
                        )}
                        
                        {/* --- VIEW FOR A SINGLE SUBJECT --- */}
                        {subjekDipilih !== 'Semua' && (
                            <>
                                <div className="bg-gray-800 rounded-xl p-6 mb-8 shadow-lg">
                                    <h2 className="text-2xl font-semibold text-white mb-4">Analisis Terperinci: {subjekDipilih}</h2>
                                    <p className="text-gray-400 mb-4">Kelas: {kelasDipilih} | Tarikh: {tarikhDipilih}</p>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                        <div className="bg-gray-700 p-4 rounded-lg"><p className="text-sm text-gray-400">GPMP</p><p className="text-2xl font-bold text-amber-400">{dataPaparan.analisisSubjek[subjekDipilih].gpmp.toFixed(2)}</p></div>
                                        {Object.entries(dataPaparan.analisisSubjek[subjekDipilih].kiraanGred).map(([gred, kiraan]) => (<div key={gred} className="bg-gray-700 p-4 rounded-lg"><p className="text-sm text-gray-400">Bilangan Gred {gred}</p><p className="text-2xl font-bold" style={{color: WARNA_GRED[gred]}}>{kiraan}</p></div>))}
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                    <div className="bg-gray-800 rounded-xl p-6 shadow-lg">
                                        <h3 className="text-xl font-semibold text-white mb-4">Taburan Gred (%)</h3>
                                        <ResponsiveContainer width="100%" height={300}>
                                            <PieChart>
                                                <Pie data={Object.entries(dataPaparan.analisisSubjek[subjekDipilih].kiraanGred).map(([name, value]) => ({name, value}))} dataKey="value" nameKey="name" cx="50%" cy="50%" outerRadius={110} label={({ name, percent }) => `${name}: ${(percent * 100).toFixed(0)}%`}>
                                                    {Object.entries(dataPaparan.analisisSubjek[subjekDipilih].kiraanGred).map(([name, value]) => <Cell key={`cell-${name}`} fill={WARNA_GRED[name]} />)}
                                                </Pie>
                                                <Tooltip contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #4B5563' }} />
                                                <Legend/>
                                            </PieChart>
                                        </ResponsiveContainer>
                                    </div>
                                    <div className="bg-gray-800 rounded-xl p-6 shadow-lg">
                                        <h3 className="text-xl font-semibold text-white mb-4">Senarai Markah Murid</h3>
                                        <div className="overflow-y-auto max-h-80"><table className="w-full text-sm text-left text-gray-300">
                                            <thead className="text-xs text-gray-400 uppercase bg-gray-700 sticky top-0"><tr><th className="px-4 py-3">Nama Murid</th><th className="px-4 py-3 text-center">Markah</th><th className="px-4 py-3 text-center">Gred</th></tr></thead>
                                            <tbody>{dataMuridDipilih.map((murid, index) => (<tr key={index} className="border-b border-gray-700 hover:bg-gray-600/50"><td className="px-4 py-3 font-medium text-white">{murid['Nama Murid 学生姓名']}</td><td className="px-4 py-3 text-center">{murid[subjekDipilih]}</td><td className="px-4 py-3 text-center font-bold" style={{color: WARNA_GRED[dapatkanGred(murid[subjekDipilih]).gred]}}>{dapatkanGred(murid[subjekDipilih]).gred}</td></tr>))}</tbody>
                                        </table></div>
                                    </div>
                                </div>
                            </>
                        )}
                    </>
                )}

            </div>
        </div>
    );
};

export default App;
